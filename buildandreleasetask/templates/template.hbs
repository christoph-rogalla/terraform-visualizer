<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Terraform Plan Visualization</title>

  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    .action-create {
      background-color: #dcfce7;
      color: #166534;
    }

    .action-update {
      background-color: #fef9c3;
      color: #854d0e;
    }

    .action-delete {
      background-color: #fee2e2;
      color: #991b1b;
    }

    .action-read {
      background-color: #e0f2fe;
      color: #075985;
    }

    pre {
      background: #f9fafb;
      padding: 0.75rem;
      border-radius: 0.5rem;
      font-size: 0.85rem;
      overflow-x: auto;
    }

    .before-diff {
      background-color: #fef2f2;
      padding: 0.5rem;
      border-radius: 0.5rem;
      overflow-x: auto;
    }

    .after-diff {
      background-color: #f0fdf4;
      padding: 0.5rem;
      border-radius: 0.5rem;
      overflow-x: auto;
    }

    .diff-span {
      padding: 0 2px;
      border-radius: 2px;
    }

    .diff-added {
      color: #166534;
      font-weight: 600;
    }

    .diff-removed {
      color: #991b1b;
      font-weight: 600;
    }

    .diff-changed {
      background-color: #fef9c3;
      font-weight: 600;
    }
  </style>
</head>

<body class="bg-gray-50 text-gray-800 font-sans p-6">
<header class="mb-8">
  <h1 class="text-3xl font-bold text-gray-900 mb-2">Terraform Plan Visualizer</h1>
  <p class="text-gray-500 mb-4">Generated overview of all resource changes</p>

  <div class="relative max-w-lg">
    <input
            id="searchInput"
            type="text"
            placeholder="Search by module or resource name..."
            class="w-full border border-gray-300 rounded-lg py-2 px-4 pl-10 focus:outline-none focus:ring-2 focus:ring-blue-500"
    />
    <svg xmlns="http://www.w3.org/2000/svg"
         class="absolute left-3 top-2.5 h-5 w-5 text-gray-400"
         fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M21 21l-4.35-4.35m0 0A7.5 7.5 0 1110.5 3a7.5 7.5 0 016.15 13.65z"/>
    </svg>
  </div>
</header>

<main id="changesContainer" class="space-y-10 mt-6">
  {{#if changes.length}}

    {{#each (groupByAction changes)}}
    {{!-- Skip rendering if this is the "read" group and it's empty --}}
      {{#if (or (ne @key "read") (gt this.length 0))}}
        <section>
          <h2 class="text-2xl font-semibold mb-4 capitalize">
            {{@key}} Resources
            <span class="px-3 py-1 rounded-full text-sm ml-2
              {{#if (eq @key "create")}}action-create{{/if}}
              {{#if (eq @key "update")}}action-update{{/if}}
              {{#if (eq @key "delete")}}action-delete{{/if}}
              {{#if (eq @key "read")}}action-read{{/if}}">
              {{this.length}}
            </span>
          </h2>

          <div class="space-y-6">
            {{#each this}}
              <section
                      class="change-item bg-white shadow-sm rounded-xl p-5 border border-gray-100 hover:shadow-md transition">
                <div class="flex items-center justify-between mb-3">
                  <div>
                    <h3 class="font-semibold text-lg text-gray-900 change-title">{{this.address}}</h3>
                    <p class="text-sm text-gray-500">{{this.type}} ({{this.mode}}) — {{this.provider_name}}</p>
                  </div>
                  <div class="flex gap-2">
                    {{#each this.change.actions}}
                      <span class="px-3 py-1 rounded-full text-sm font-medium capitalize
                                   {{#if (eq this "create")}}action-create{{/if}}
                        {{#if (eq this "update")}}action-update{{/if}}
                        {{#if (eq this "delete")}}action-delete{{/if}}
                        {{#if (eq this "read")}}action-read{{/if}}">
                        {{this}}
                      </span>
                    {{/each}}
                  </div>
                </div>

                <details class="mt-2">
                  <summary class="cursor-pointer text-sm text-gray-600 hover:text-gray-900">
                    View Details
                  </summary>
                  <div class="grid grid-cols-2 gap-4 mt-3">
                    <div>
                      <h4 class="font-medium text-gray-700 mb-1">Before</h4>
                      {{{diffHighlight this.change.before this.change.after "before"}}}
                    </div>
                    <div>
                      <h4 class="font-medium text-gray-700 mb-1">After</h4>
                      {{{diffHighlight this.change.before this.change.after "after"}}}
                    </div>
                  </div>
                </details>
              </section>
            {{/each}}
          </div>
        </section>
      {{/if}}
    {{/each}}

  {{else}}
    <p class="text-gray-600 text-center italic">No resource changes found.</p>
  {{/if}}
</main>

<footer class="mt-10 text-center text-sm text-gray-400">
  Generated automatically by Terraform Visualizer Task
</footer>

<script>
  const searchInput = document.getElementById('searchInput');
  const items = document.querySelectorAll('.change-item');

  searchInput.addEventListener('input', (e) => {
    const query = e.target.value.toLowerCase().trim();
    items.forEach(item => {
      const title = item.querySelector('.change-title').textContent.toLowerCase();
      item.style.display = title.includes(query) ? '' : 'none';
    });
  });
</script>
</body>
</html>
